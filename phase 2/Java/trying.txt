package OS;

import com.jcraft.jsch.ChannelSftp;
import com.jcraft.jsch.JSch;
import com.jcraft.jsch.JSchException;
import com.jcraft.jsch.Session;
import com.jcraft.jsch.SftpException;

import java.io.*;
import java.net.Socket;
import java.util.Properties;

public class infoservice extends Thread {
    private Socket nextClient;
    private PrintWriter to_client;
    private BufferedReader from_client;
    private String hostname;
    private String IP;
    private String clientusername;
    JSch jsch = new JSch();
    Session session = null;
    ChannelSftp channelSftp = null;
    public infoservice(Socket nextClient) {
        this.nextClient = nextClient;
        this.hostname = nextClient.getInetAddress().getHostName();
        this.IP = nextClient.getInetAddress().getHostAddress();
    }

    @Override
    public synchronized void run() {
        try {
            // Initialize streams for communication with the client
            to_client = new PrintWriter(nextClient.getOutputStream(), true);
            from_client = new BufferedReader(new InputStreamReader(nextClient.getInputStream()));
            
            clientusername=from_client.readLine();
            File outputFile = new File("info.txt");
            ProcessBuilder SystemRunCommand = new ProcessBuilder("bash", "/home/vm1/System.sh");
            SystemRunCommand.redirectOutput(outputFile);
            SystemRunCommand.redirectErrorStream(true); // Combine standard error and output streams
			Process Systeminfo = SystemRunCommand.start();
			Systeminfo.waitFor();
			Thread.sleep(500);
            session = jsch.getSession(clientusername, IP, 22);
            session.setPassword("123");
            Properties config = new Properties();
            config.put("StrictHostKeyChecking", "no");
            session.setConfig(config);
            // Use SFTP to upload the System.sh file
            //uploadFileViaSFTP(IP, "123", "/home/vm1/System.sh");
            session.connect();
            channelSftp = (ChannelSftp) session.openChannel("sftp");
            channelSftp.connect();
            File file = new File("/home/vm1/info.txt");
            channelSftp.put(new FileInputStream(outputFile), outputFile.getName());

        } catch (IOException | JSchException | SftpException | InterruptedException e) {
            System.err.println("Error initializing client communication streams: " + e.getMessage());
        }finally {
            // Disconnect the channel and session
            if (channelSftp != null) {
            	channelSftp.disconnect();
            }
            if (session != null) {
                session.disconnect();
            }
        }
    }


}
